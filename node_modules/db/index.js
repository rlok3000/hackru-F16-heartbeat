var mongodbclient = require('mongodb').MongoClient;
var mongodb;
var twilionotifier = require('twilionotifier');

mongodbclient.connect("mongodb://localhost:27017/hackru", function(err, db) {
  if(!err) {
    console.log("Mongo connection succeeded");
    mongodb = db;
  }
  else {
    console.log(err);
  }
});

exports.createAccount = function(username, password, name, age, heartbeatwarning, heartbeatdanger, usernumber, emcnumber) {
  mongodb.createCollection('users');
  var users = mongodb.collection('users');
  users.insert({'username':username, 'password':password, 'name':name, 'age':age, 'heartbeatwarning':heartbeatwarning, 'heartbeatdanger':heartbeatdanger, 'usernumber':usernumber, 'emcnumber': emcnumber});;
}

exports.loginAccount = function(username, password, callback) {
  mongodb.createCollection('users');
  var users = mongodb.collection('users');
  users.findOne({'username':username, 'password':password}, function(err, cursor) {
    if(cursor == null)
      return callback('error');
    return callback(cursor);
  });
}

exports.updateHeartbeat = function(username, password, heartbeat) {
  mongodb.createCollection('users');
  var users = mongodb.collection('users');
  users.update({'username':username, 'password':password},{$set:{'heartbeat':heartbeat}});
  users.findOne({'username':username, 'password':password}, function(err, cursor) {
    console.log(cursor.heartbeatdanger);
    console.log(heartbeat);
    if(cursor.heartbeatdanger > heartbeat) {
      twilionotifier.sendCall(cursor.usernumber);
    }
    else if(cursor.heartbeatwarning > heartbeat) {
      twilionotifier.sendSms(cursor.usernumber);
    }
  });
}
